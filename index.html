<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ranked Group Matcher</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:Arial, sans-serif;
  background:#f4f6f9;
  padding:20px;
}
.container{
  max-width:1000px;
  margin:auto;
  background:white;
  padding:25px;
  border-radius:10px;
  box-shadow:0 5px 20px rgba(0,0,0,.1);
}
.checkbox-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:6px;
}
.option-row{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:14px;
}
.section{
  margin-top:30px;
}
.group-box{
  background:#eef2ff;
  padding:15px;
  margin:15px 0;
  border-radius:8px;
}
.user-box{
  background:#f0fdf4;
  padding:12px;
  margin:12px 0;
  border-radius:8px;
}
button{
  margin-top:20px;
  padding:10px 20px;
  border:none;
  border-radius:6px;
  background:#2563eb;
  color:white;
  cursor:pointer;
}
</style>
</head>
<body>

<div class="container">

<h1>Ranked Preference Matcher</h1>

<label><strong>Avatar Name:</strong></label><br>
<input type="text" id="avatarName" style="width:100%;padding:8px;"><br>

<div id="questions"></div>

<button onclick="submitAnswers()">Submit</button>

<hr>

<h2>Your Submitted Answers</h2>
<div id="personalOutput"></div>

<hr>

<h2>All Participants</h2>
<div id="allUsers"></div>

<hr>

<h2>Generated Groups</h2>
<div id="groupOutput"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ðŸ”¥ REPLACE WITH YOUR FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* QUESTIONS */
const questionsData = [
{
title:"Rank Your Top 3 Interests",
options:["Art","Music","Coding","Robotics","Design","Gaming","AI","Writing","Science","History","Math","Nature","Film","Architecture","Fashion"]
},
{
title:"Rank Your Top 3 Work Styles",
options:["Hands-on","Research","Sketching","Digital","Physical","Collaborative","Independent","Experimental","Structured","Improvisational","Leadership","Support Role","Fast-paced","Slow-paced","Analytical"]
},
{
title:"Rank Your Top 3 Themes",
options:["Future","Past","Identity","Environment","Technology","Dreams","Data","War","Myth","Machines","Body","Space","Urban","Nature","Speculation"]
}
];

/* BUILD QUESTIONS */
function buildQuestions(){
const container=document.getElementById("questions");

questionsData.forEach((q,index)=>{
const section=document.createElement("div");
section.className="section";
section.innerHTML=`<h3>${q.title}</h3>
<p>Select 3 options and assign unique ranks.</p>`;

const grid=document.createElement("div");
grid.className="checkbox-grid";

q.options.forEach(opt=>{
grid.innerHTML+=`
<label class="option-row">
<input type="checkbox" name="q${index}" value="${opt}">
${opt}
<select disabled name="rank${index}">
<option value="">Rank</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
</select>
</label>
`;
});

section.appendChild(grid);
container.appendChild(section);
setupRankingLogic(index);
});
}

function setupRankingLogic(index){
const checkboxes=document.querySelectorAll(`input[name="q${index}"]`);

checkboxes.forEach(cb=>{
const select=cb.parentElement.querySelector("select");

cb.addEventListener("change",()=>{
select.disabled=!cb.checked;
if(!cb.checked){select.value="";}
enforceUnique(index);
});

select.addEventListener("change",()=>enforceUnique(index));
});
}

function enforceUnique(index){
const selects=document.querySelectorAll(`select[name="rank${index}"]`);
let used=[];
selects.forEach(s=>{
if(s.value){
if(used.includes(s.value)){
alert("Each rank can only be used once.");
s.value="";
}else{
used.push(s.value);
}
}
});
}

/* SUBMIT */
async function submitAnswers(){
const name=document.getElementById("avatarName").value.trim();
if(!name){alert("Enter avatar name.");return;}

let answers=[];
let valid=true;

questionsData.forEach((q,index)=>{
const checkboxes=document.querySelectorAll(`input[name="q${index}"]`);
let ranked=[];
checkboxes.forEach(cb=>{
const select=cb.parentElement.querySelector("select");
if(cb.checked && select.value){
ranked.push({option:cb.value,rank:parseInt(select.value)});
}
});
if(ranked.length!==3){valid=false;}
ranked.sort((a,b)=>a.rank-b.rank);
answers.push(ranked);
});

if(!valid){
alert("Each question must have exactly 3 ranked answers.");
return;
}

await addDoc(collection(db,"users"),{name,answers});
displayPersonal(name,answers);
loadAllUsers();
}

/* DISPLAY PERSONAL */
function displayPersonal(name,answers){
const div=document.getElementById("personalOutput");
div.innerHTML=`
<div class="user-box">
<strong>${name}</strong><br>
${answers.map((a,i)=>
`Q${i+1}: ${a.map(x=>`#${x.rank} ${x.option}`).join(", ")}`
).join("<br>")}
</div>`;
}

/* LOAD ALL USERS */
async function loadAllUsers(){
const snapshot=await getDocs(collection(db,"users"));
let users=[];
snapshot.forEach(doc=>users.push(doc.data()));

displayAllUsers(users);
generateGroups(users);
}

function displayAllUsers(users){
const container=document.getElementById("allUsers");
container.innerHTML="";
users.forEach(u=>{
container.innerHTML+=`
<div class="user-box">
<strong>${u.name}</strong><br>
${u.answers.map((a,i)=>
`Q${i+1}: ${a.map(x=>`#${x.rank} ${x.option}`).join(", ")}`
).join("<br>")}
</div>`;
});
}

/* GROUPING (Balanced 3â€“4) */
function generateGroups(users){
const container=document.getElementById("groupOutput");
container.innerHTML="";
if(users.length<3){
container.innerHTML="Not enough users yet.";
return;
}

let groups=[];
let size=3;
for(let i=0;i<users.length;i+=size){
groups.push(users.slice(i,i+size));
}

groups.forEach((g,i)=>{
let common=findCommon(g);
container.innerHTML+=`
<div class="group-box">
<h3>Group ${i+1}</h3>
<strong>Members:</strong> ${g.map(u=>u.name).join(", ")}<br><br>
${common}
</div>`;
});
}

/* COMMON ANSWERS */
function findCommon(group){
let html="";
for(let q=0;q<questionsData.length;q++){
let counts={};
group.forEach(user=>{
user.answers[q].forEach(a=>{
counts[a.option]=(counts[a.option]||0)+1;
});
});
let shared=Object.entries(counts)
.filter(([opt,count])=>count>1)
.map(([opt])=>opt);

html+=`<strong>Common in Q${q+1}:</strong> ${shared.length?shared.join(", "):"None"}<br>`;
}
return html;
}

buildQuestions();
loadAllUsers();
window.submitAnswers=submitAnswers;

</script>

</body>
</html>
