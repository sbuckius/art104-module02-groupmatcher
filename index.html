<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ranked Group Matcher</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Export Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  font-family:Arial;
  background:#f3f4f6;
  padding:20px;
}
.container{
  max-width:1000px;
  margin:auto;
  background:white;
  padding:25px;
  border-radius:10px;
  box-shadow:0 5px 20px rgba(0,0,0,.1);
}
.section{ margin-top:30px; }
.checkbox-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:6px;
}
.option-row{
  display:flex;
  align-items:center;
  gap:8px;
}
.box{
  background:#eef2ff;
  padding:15px;
  margin:12px 0;
  border-radius:8px;
}
.button{
  margin-top:15px;
  padding:8px 16px;
  border:none;
  border-radius:6px;
  background:#2563eb;
  color:white;
  cursor:pointer;
}
.admin{
  margin-top:30px;
  padding:15px;
  background:#fee2e2;
  border-radius:8px;
}
#submissionStatus span{
  display:inline-block;
  padding:6px 12px;
  margin:4px;
  background:#dbeafe;
  border-radius:20px;
  font-size:14px;
}
</style>
</head>
<body>

<div class="container">

<h1>Ranked Preference Matcher</h1>

<label><strong>Avatar Name:</strong></label><br>
<input type="text" id="avatarName" style="width:100%;padding:8px;"><br>

<div id="questions"></div>

<button onclick="submitAnswers()">Submit</button>

<hr>

<h2>Submitted Avatars</h2>
<div id="submissionStatus"></div>

<hr>

<h2>All Participants</h2>
<div id="allUsers"></div>

<button onclick="exportPNG()">Export as PNG</button>
<button onclick="exportPDF()">Export as PDF</button>

<hr>

<h2>Generated Groups</h2>
<div id="groupOutput"></div>

<div class="admin">
<h3>Admin Controls</h3>
<input type="password" id="adminPass" placeholder="Enter admin password">
<button onclick="adminReset()">Reset All Data</button>
</div>

</div>

<!-- Firebase -->
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ðŸ”¥ INSERT YOUR FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyDG_zmeJfITZ1EFyLk3iOb74pqU8VadQQs",
  authDomain: "art104module02groupsetup.firebaseapp.com",
  databaseURL: "https://art104module02groupsetup-default-rtdb.firebaseio.com",
  projectId: "art104module02groupsetup",
  storageBucket: "art104module02groupsetup.firebasestorage.app",
  messagingSenderId: "558666089511",
  appId: "1:558666089511:web:646e0cb76ad04952e53a02",
  measurementId: "G-1PVD2SG6RN"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ADMIN_PASSWORD = "admin123";  // change this

const questions = [
{
title:"Rank Top 3 Interests",
options:["Art","Music","Coding","Robotics","Design","Gaming","AI","Writing","Science","History","Math","Nature"]
},
{
title:"Rank Top 3 Work Styles",
options:["Collaborative","Independent","Experimental","Structured","Leadership","Support","Fast","Slow","Analytical"]
},
{
title:"Rank Top 3 Themes",
options:["Future","Past","Identity","Environment","Technology","Dreams","Data","Myth","Machines","Space"]
}
];

/* BUILD UI */
function buildUI(){
const container=document.getElementById("questions");

questions.forEach((q,index)=>{
const div=document.createElement("div");
div.className="section";
div.innerHTML=`<h3>${q.title}</h3>`;
const grid=document.createElement("div");
grid.className="checkbox-grid";

q.options.forEach(opt=>{
grid.innerHTML+=`
<label class="option-row">
<input type="checkbox" name="q${index}" value="${opt}">
${opt}
<select disabled name="rank${index}">
<option value="">Rank</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
</select>
</label>
`;
});

div.appendChild(grid);
container.appendChild(div);
setupRanking(index);
});
}

/* RANKING LOGIC */
function setupRanking(index){
const checks=document.querySelectorAll(`input[name="q${index}"]`);
checks.forEach(cb=>{
const select=cb.parentElement.querySelector("select");
cb.addEventListener("change",()=>{
select.disabled=!cb.checked;
if(!cb.checked) select.value="";
enforceUnique(index);
});
select.addEventListener("change",()=>enforceUnique(index));
});
}

function enforceUnique(index){
const selects=document.querySelectorAll(`select[name="rank${index}"]`);
let used=[];
selects.forEach(s=>{
if(s.value){
if(used.includes(s.value)){
alert("Rank already used.");
s.value="";
}else used.push(s.value);
}
});
}

/* SUBMIT */
async function submitAnswers(){
const name=document.getElementById("avatarName").value.trim();
if(!name){alert("Enter name");return;}

let answers=[];
let valid=true;

questions.forEach((q,index)=>{
let ranked=[];
document.querySelectorAll(`input[name="q${index}"]`).forEach(cb=>{
const sel=cb.parentElement.querySelector("select");
if(cb.checked && sel.value){
ranked.push({option:cb.value,rank:parseInt(sel.value)});
}
});
if(ranked.length!==3) valid=false;
ranked.sort((a,b)=>a.rank-b.rank);
answers.push(ranked);
});

if(!valid){
alert("Each question needs 3 ranked choices.");
return;
}

await addDoc(collection(db,"users"),{name,answers});
loadUsers();
}

/* LOAD USERS */
async function loadUsers(){
const snapshot=await getDocs(collection(db,"users"));
let users=[];
snapshot.forEach(doc=>{
users.push({id:doc.id,...doc.data()});
});

displaySubmissionStatus(users);
displayUsers(users);
displayGroups(users);
}

/* DISPLAY SUBMISSIONS */
function displaySubmissionStatus(users){
const div=document.getElementById("submissionStatus");
div.innerHTML="";

const maxUsers = 24;
const count = users.length;

div.innerHTML += `<div style="margin-bottom:10px;font-weight:bold;">${count} / ${maxUsers} submitted</div>`;

users.forEach(u=>{
div.innerHTML += `<span>${u.name}</span>`;
});

if(count >= maxUsers){
div.innerHTML += `<div style="margin-top:10px;color:green;font-weight:bold;">All submissions complete.</div>`;
}
}

/* DISPLAY USERS */
function displayUsers(users){
const div=document.getElementById("allUsers");
div.innerHTML="";
users.forEach(u=>{
div.innerHTML+=`
<div class="box">
<strong>${u.name}</strong><br>
${u.answers.map((a,i)=>
`Q${i+1}: ${a.map(x=>"#"+x.rank+" "+x.option).join(", ")}`
).join("<br>")}
</div>`;
});
}

/* DISPLAY GROUPS */
function displayGroups(users){
const div=document.getElementById("groupOutput");
div.innerHTML="";
if(users.length<3){div.innerHTML="Not enough users.";return;}

for(let i=0;i<users.length;i+=3){
let group=users.slice(i,i+3);
let commonHTML="";
for(let q=0;q<questions.length;q++){
let counts={};
group.forEach(u=>{
u.answers[q].forEach(a=>{
counts[a.option]=(counts[a.option]||0)+1;
});
});
let common=Object.entries(counts)
.filter(([k,v])=>v>1)
.map(([k])=>k);
commonHTML+=`Common Q${q+1}: ${common.length?common.join(", "):"None"}<br>`;
}
div.innerHTML+=`
<div class="box">
<strong>Group ${Math.floor(i/3)+1}</strong><br>
Members: ${group.map(u=>u.name).join(", ")}<br><br>
${commonHTML}
</div>`;
}
}

/* EXPORT */
window.exportPNG = function(){
html2canvas(document.body).then(canvas=>{
const link=document.createElement("a");
link.download="results.png";
link.href=canvas.toDataURL();
link.click();
});
};

window.exportPDF = async function(){
const { jsPDF } = window.jspdf;
const pdf = new jsPDF();
const canvas = await html2canvas(document.body);
const img = canvas.toDataURL("image/png");
pdf.addImage(img,"PNG",0,0,210,297);
pdf.save("results.pdf");
};

/* ADMIN RESET */
window.adminReset = async function(){
const pass=document.getElementById("adminPass").value;
if(pass!==ADMIN_PASSWORD){
alert("Incorrect password.");
return;
}
const snapshot=await getDocs(collection(db,"users"));
snapshot.forEach(async d=>{
await deleteDoc(doc(db,"users",d.id));
});
alert("All data reset.");
loadUsers();
};

buildUI();
loadUsers();
window.submitAnswers=submitAnswers;

</script>
</body>
</html>
